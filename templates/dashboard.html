{% extends "base.html" %}
{% block content %}

<a href="{{ url_for('usuarios') }}" class="text-sm text-indigo-600 hover:underline">👤 Gestionar usuarios</a>
<div class="max-w-7xl mx-auto px-4 py-8">
  <h2 class="text-3xl font-bold text-indigo-600 mb-6 text-center">📊 Panel de Inventario</h2>

  <!-- Métricas resumen -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <div class="bg-white p-4 shadow rounded-xl border-t-4 border-blue-500">
      <h2 class="text-lg font-semibold text-gray-700">Total Productos</h2>
      <p class="text-2xl font-bold text-blue-600">{{ productos|length }}</p>
    </div>
    <div class="bg-white p-4 shadow rounded-xl border-t-4 border-green-500">
      <h2 class="text-lg font-semibold text-gray-700">Stock Total</h2>
      <p class="text-2xl font-bold text-green-600">
        {{ productos | sum(attribute='cantidad') }}
      </p>
    </div>
    <div class="bg-white p-4 shadow rounded-xl border-t-4 border-yellow-500">
      <h2 class="text-lg font-semibold text-gray-700">Alertas activas</h2>
      <p class="text-2xl font-bold text-yellow-600">
        {{ productos | selectattr('cantidad', 'lt', 5) | list | length }}
      </p>
    </div>
  </div>

  <!-- Alertas -->
  {% if alertas %}
  <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 rounded-lg p-4 mb-8">
    <h3 class="font-semibold mb-2">⚠️ Alertas de Stock</h3>
    <ul class="list-disc pl-5">
      {% for a in alertas %}
        <li>
          Producto <strong>{{ a.nombre }}</strong> tiene un stock 
          {% if a.tipo == 'bajo' %}<span class="text-red-600">bajo</span>{% else %}<span class="text-green-600">alto</span>{% endif %}
          ({{ a.cantidad }} unidades)
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- 📈 Gráfico -->
  <div class="bg-white shadow rounded p-4 mb-8">
    <h3 class="text-lg font-semibold mb-3">📦 Inventario actual</h3>
    <canvas id="graficoStock" height="100"></canvas>
  </div>
  <form method="GET" action="{{ url_for('dashboard') }}" class="mb-4 flex gap-2">
  <input type="text" name="q" placeholder="🔍 Buscar producto..." value="{{ request.args.get('q', '') }}"
         class="border p-2 rounded w-full" />
  <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
    Buscar
  </button>
</form>

  <!-- Tabla de productos -->
  <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200 mb-8">
    <table class="min-w-full table-auto text-sm">
      <thead class="bg-indigo-100 text-indigo-700 uppercase text-xs">
        <tr>
          <th class="px-4 py-3">🛒 Nombre</th>
          <th class="px-4 py-3">📂 Categoría</th>
          <th class="px-4 py-3">📦 Unidad</th>
          <th class="px-4 py-3">🏢 Proveedor</th>
          <th class="px-4 py-3">💰 Precio</th>
          <th class="px-4 py-3">📉 Stock actual</th>
        </tr>
      </thead>
      <tbody>
        {% if not productos %}
  <div class="text-center text-gray-500 mt-6">🔎 No se encontraron productos.</div>
  {% endif %}
        
        {% for p in productos %}
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="px-4 py-2 font-medium">{{ p.nombre }}</td>
          <td class="px-4 py-2 text-gray-600">{{ p.categoria or '-' }}</td>
          <td class="px-4 py-2 text-gray-600">{{ p.unidad or '-' }}</td>
          <td class="px-4 py-2 text-gray-600">{{ p.proveedor or '-' }}</td>
          <td class="px-4 py-2 text-gray-600">${{ '%.2f' | format(p.precio or 0) }}</td>
          <td class="px-4 py-2 font-semibold text-gray-800">{{ p.cantidad }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if recomendaciones %}
<div class="bg-gradient-to-br from-indigo-50 to-white border border-indigo-200 rounded-2xl p-6 shadow mb-8">
  <h2 class="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
    🤖 Recomendaciones inteligentes de inventario
  </h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for r in recomendaciones %}
    <div class="bg-white border border-indigo-100 rounded-xl p-4 shadow-sm hover:shadow-md transition">
      <h3 class="text-md font-semibold text-indigo-600 mb-2">
        🛒 {{ r.nombre }}
      </h3>
      <p class="text-sm text-gray-700 leading-relaxed">
        {{ r.sugerencia }}
      </p>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

  <!-- 🔮 Predicción -->
  <div class="text-center">
    <a href="{{ url_for('prediccion') }}" class="inline-block text-blue-600 hover:underline text-sm">📈 Ver predicción de demanda</a>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('graficoStock');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ nombres|tojson }},
      datasets: [{
        label: 'Cantidad actual',
        data: {{ cantidades|tojson }},
        backgroundColor: 'rgba(34,197,94,0.6)',
        borderColor: 'rgba(22,163,74,1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>

{% endblock %}


